# SageAlpha.ai v3.0 - Azure App Service Deployment
# CI/CD Pipeline: Build, Test, Deploy
#
# Required GitHub Secrets:
#   AZURE_WEBAPP_NAME           - Your Azure Web App name (e.g., sagealpha-prod)
#   AZURE_WEBAPP_PUBLISH_PROFILE - Download from Azure Portal > Your App > Deployment Center
#
# Optional Secrets (for testing with Azure services):
#   AZURE_OPENAI_ENDPOINT       - Azure OpenAI endpoint
#   AZURE_OPENAI_API_KEY        - Azure OpenAI API key
#   AZURE_STORAGE_CONNECTION_STRING - Azure Blob Storage connection string
#   DATABASE_URL                - PostgreSQL connection string for production

name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: '3.11'
  AZURE_WEBAPP_PACKAGE_PATH: '.'

jobs:
  # ==================== Lint & Type Check ====================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy black isort
          pip install -r requirements.txt
      
      - name: Check code formatting (Black)
        run: |
          black --check --diff . || echo "::warning::Code formatting issues found. Run 'black .' to fix."
        continue-on-error: true
      
      - name: Check import sorting (isort)
        run: |
          isort --check-only --diff . || echo "::warning::Import sorting issues found. Run 'isort .' to fix."
        continue-on-error: true
      
      - name: Lint with flake8
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=15 --max-line-length=120 --statistics
      
      - name: Type check with mypy
        run: |
          mypy app.py --ignore-missing-imports --no-error-summary || echo "::warning::Type checking issues found."
        continue-on-error: true

  # ==================== Test ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Create test environment
        run: |
          echo "FLASK_ENV=testing" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
      
      - name: Run tests
        run: |
          # Create tests directory if it doesn't exist
          mkdir -p tests
          
          # Run pytest if tests exist, otherwise verify app imports
          if [ -d "tests" ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pytest tests/ -v --tb=short --cov=. --cov-report=xml
          else
            echo "No tests found. Verifying app can be imported..."
            python -c "from app import create_app; app = create_app(); print('‚úì App imports successfully')"
          fi
      
      - name: Verify startup script
        run: |
          python -c "import startup; print('‚úì Startup script imports successfully')"

  # ==================== Build ====================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Prepare deployment package
        run: |
          # Remove development files
          rm -rf .git .github .gitignore .env.local .env.development
          rm -rf __pycache__ */__pycache__ */*/__pycache__
          rm -rf .pytest_cache .mypy_cache .coverage
          rm -rf tests/ docs/ *.md
          
          # Keep essential files
          echo "Deployment package contents:"
          ls -la
      
      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            .
            !venv/
            !.git/
            !.github/
            !__pycache__/
            !*.pyc
            !.env*
            !tests/

  # ==================== Deploy ====================
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .
      
      - name: Deploy to Azure Web App
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
      
      - name: Output deployment URL
        run: |
          echo "üöÄ Deployed to: ${{ steps.deploy.outputs.webapp-url }}"
          echo ""
          echo "Azure App Service Configuration Checklist:"
          echo "  1. Enable WebSockets: Configuration > General settings > Web sockets: On"
          echo "  2. Set startup command: Configuration > General settings > Startup Command: python startup.py"
          echo "  3. Add environment variables in Configuration > Application settings:"
          echo "     - FLASK_SECRET"
          echo "     - AZURE_OPENAI_ENDPOINT"
          echo "     - AZURE_OPENAI_API_KEY"
          echo "     - AZURE_OPENAI_DEPLOYMENT"
          echo "     - AZURE_STORAGE_CONNECTION_STRING (optional)"
          echo "     - DATABASE_URL (optional, for PostgreSQL)"
          echo "     - AZURE_REDIS_CONNECTION_STRING (optional, for Celery)"

  # ==================== Notify ====================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed or skipped"
          fi

