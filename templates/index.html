<!DOCTYPE html>
<html lang="en" class="h-full" x-data="{ darkMode: localStorage.getItem('theme') === 'dark' }" :class="{ 'dark': darkMode }">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SageAlpha.ai â€” Chat</title>
  
  <!-- Tailwind CSS 3.x CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            sage: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7c3aed',
              800: '#6b21a8',
              900: '#581c87',
              950: '#3b0764',
            },
            primary: '#8B5CF6',
          },
          fontFamily: {
            display: ['Clash Display', 'system-ui', 'sans-serif'],
            sans: ['Satoshi', 'Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'typing': 'typing 1.4s infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            typing: {
              '0%, 100%': { opacity: '0.3' },
              '50%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- HTMX for dynamic interactions -->
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  
  <!-- Socket.IO for real-time chat -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  
  <!-- html2pdf for client-side PDF generation -->
  <script src="/static/libs/html2pdf.bundle.min.js"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    @import url('https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&f[]=clash-display@600,700&display=swap');
    
    body { font-family: 'Satoshi', 'Inter', system-ui, sans-serif; }
    
    .glass-sidebar {
      background: linear-gradient(180deg, rgba(30, 27, 75, 0.95) 0%, rgba(49, 46, 129, 0.9) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .glass-nav {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .dark .glass-nav {
      background: rgba(15, 23, 42, 0.9);
    }
    
    .msg-user {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 50%, #6D28D9 100%);
    }
    
    .msg-assistant {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .dark .msg-assistant {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .composer-glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .dark .composer-glass {
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 3px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
    
    .typing-indicator span {
      animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    .gradient-border {
      background: linear-gradient(135deg, #8B5CF6, #A855F7, #C084FC);
      padding: 2px;
      border-radius: 16px;
    }
    
    .gradient-border > div {
      background: white;
      border-radius: 14px;
    }
    
    .dark .gradient-border > div {
      background: #0f172a;
    }
  </style>
</head>

<body class="h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">
  
  <div x-data="chatApp()" 
       x-init="init()"
       class="h-full flex flex-col">
    
    <!-- Top Navigation -->
    <header class="glass-nav sticky top-0 z-50 border-b border-slate-200/50 dark:border-slate-800/50">
      <div class="flex items-center justify-between px-4 h-16">
        <!-- Logo & Brand -->
        <div class="flex items-center gap-3 cursor-pointer" @click="newChat()">
        <img src="{{ url_for('static', filename='img/sagealpha-logo.png') }}"
               alt="SageAlpha" 
               class="h-8 w-auto hover:scale-105 transition-transform"
               onerror="this.style.display='none'">
          <span class="hidden sm:inline-flex items-center gap-2">
            <span class="font-display font-bold text-lg">SageAlpha</span>
            <span class="text-xs bg-sage-100 dark:bg-sage-900/50 text-sage-700 dark:text-sage-300 px-2 py-0.5 rounded-full font-medium">
              v{{ APP_VERSION }}
            </span>
          </span>
      </div>

        <!-- Right Controls -->
        <div class="flex items-center gap-3">
          <!-- Theme Toggle -->
          <button @click="toggleTheme()"
                  class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                  :title="darkMode ? 'Switch to light mode' : 'Switch to dark mode'">
            <svg x-show="!darkMode" class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
            <svg x-show="darkMode" class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
          </button>
          
          <!-- Mobile Sidebar Toggle -->
          <button @click="sidebarOpen = !sidebarOpen"
                  class="lg:hidden p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        </div>
      </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
      
      <!-- Sidebar -->
      <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'"
             class="fixed lg:relative inset-y-0 left-0 z-40 w-72 glass-sidebar text-white flex flex-col transform transition-transform duration-300 ease-in-out lg:translate-x-0">
        
        <!-- New Chat Button -->
        <div class="p-4">
          <button @click="newChat()"
                  class="w-full py-3.5 px-4 bg-gradient-to-r from-sage-500 to-sage-600 hover:from-sage-600 hover:to-sage-700 text-white font-semibold rounded-xl shadow-lg shadow-sage-500/25 hover:shadow-sage-500/40 transition-all duration-300 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Chat
          </button>
        </div>

        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto scrollbar-thin px-3 pb-4">
          <p class="text-xs font-semibold text-sage-300/50 uppercase tracking-wider px-2 mb-3">Recent Chats</p>
          <div class="space-y-1.5">
            <template x-for="sess in sessions" :key="sess.id">
              <button @click="openSession(sess.id)"
                      :class="currentSessionId === sess.id ? 'bg-white/15 border-sage-400/30' : 'bg-white/5 border-transparent hover:bg-white/10'"
                      class="w-full text-left px-3 py-3 rounded-xl border transition-all duration-200 group">
                <div class="flex items-start gap-3">
                  <svg class="w-4 h-4 mt-0.5 text-sage-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-white/90 truncate" x-text="sess.title"></p>
                    <p class="text-xs text-sage-300/50 mt-0.5" x-text="formatDate(sess.created)"></p>
                  </div>
                </div>
              </button>
            </template>
          </div>
        </div>

        <!-- User Info -->
        <div class="p-4 border-t border-white/10" x-data="{ menuOpen: false }">
          <button @click="menuOpen = !menuOpen" 
                  @click.away="menuOpen = false"
                  class="w-full flex items-center gap-3 p-2 rounded-xl hover:bg-white/10 transition-colors relative">
            <img :src="user.avatar_url || '{{ url_for('static', filename='img/default-avatar.png') }}'" 
                 class="w-10 h-10 rounded-full border-2 border-sage-400/50 object-cover"
                 onerror="this.src='{{ url_for('static', filename='img/default-avatar.png') }}'">
            <div class="flex-1 text-left min-w-0">
              <p class="font-semibold text-sm truncate" x-text="user.username || 'Guest'"></p>
              <p class="text-xs text-sage-300/60 truncate" x-text="user.email || 'guest@local'"></p>
          </div>
            <svg class="w-4 h-4 text-sage-300/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
            </svg>
            
            <!-- Dropdown Menu -->
            <div x-show="menuOpen"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 translate-y-2"
                 class="absolute bottom-full left-0 right-0 mb-2 bg-slate-900 rounded-xl shadow-2xl border border-white/10 overflow-hidden"
                 style="display: none;">
              <a href="/profile" class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors">
                <svg class="w-4 h-4 text-sage-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-sm">Profile</span>
              </a>
              <a href="/logout" class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors text-red-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span class="text-sm">Logout</span>
              </a>
          </div>
          </button>
        </div>
      </aside>

      <!-- Sidebar Overlay (Mobile) -->
      <div x-show="sidebarOpen"
           @click="sidebarOpen = false"
           class="fixed inset-0 bg-black/50 z-30 lg:hidden"
           x-transition:enter="transition-opacity ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition-opacity ease-in duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           style="display: none;"></div>
      
      <!-- Chat Area -->
      <main class="flex-1 flex flex-col min-w-0"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop($event)">
        
        <!-- Drag Overlay -->
        <div x-show="isDragging" 
             class="fixed inset-0 bg-sage-500/20 backdrop-blur-sm z-50 flex items-center justify-center"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             style="display: none;">
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-2xl text-center">
            <svg class="w-16 h-16 mx-auto text-sage-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <p class="text-xl font-semibold text-slate-900 dark:text-white">Drop PDF here to upload</p>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Supported: PDF, TXT, MD, CSV</p>
          </div>
        </div>
        
        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto scrollbar-thin" id="messagesContainer">
          <div class="max-w-4xl mx-auto px-4 py-8">
            
            <!-- Empty State -->
            <div x-show="messages.length === 0 && !currentDocument" class="text-center py-20">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-sage-500 to-sage-700 mb-6 shadow-2xl shadow-sage-500/30">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              <h2 class="text-3xl font-display font-bold text-slate-900 dark:text-white mb-3">
                Where should we begin?
              </h2>
              <p class="text-slate-600 dark:text-slate-400 max-w-md mx-auto mb-8">
                Upload a PDF research report or type a message to start.
              </p>
              
              <!-- Sample Report CTA Card -->
              <div class="gradient-border max-w-md mx-auto mb-6 cursor-pointer hover:scale-[1.02] transition-transform duration-300"
                   @click="downloadReport()">
                <div class="flex items-center gap-4 p-4">
                  <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-sage-100 dark:bg-sage-900/50 flex items-center justify-center">
                    <svg class="w-6 h-6 text-sage-600 dark:text-sage-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <div class="flex-1 text-left">
                    <p class="font-semibold text-slate-900 dark:text-white">Download equity research report</p>
                    <p class="text-sm text-slate-500 dark:text-slate-400">CRH PLC â€” SageAlpha Capital</p>
      </div>
                  <svg class="w-5 h-5 text-sage-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
    </div>
  </div>

            <!-- Messages -->
            <div class="space-y-6" id="messages">
              <template x-for="(msg, index) in messages" :key="index">
                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'"
                     class="animate-slide-up">
                  <div :class="msg.role === 'user' ? 'msg-user text-white ml-12' : 'msg-assistant dark:text-slate-100 mr-12'"
                       class="max-w-[80%] rounded-2xl px-5 py-4 shadow-sm">
                    <p class="whitespace-pre-wrap leading-relaxed" x-html="formatMessage(msg.content)"></p>
                  </div>
                </div>
              </template>
              
              <!-- Typing Indicator -->
              <div x-show="isTyping" class="flex justify-start animate-fade-in" style="display: none;">
                <div class="msg-assistant dark:text-slate-100 rounded-2xl px-5 py-4 shadow-sm">
                  <div class="typing-indicator flex gap-1.5">
                    <span class="w-2 h-2 bg-sage-500 rounded-full"></span>
                    <span class="w-2 h-2 bg-sage-500 rounded-full"></span>
                    <span class="w-2 h-2 bg-sage-500 rounded-full"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Composer -->
        <div class="composer-glass border-t border-slate-200 dark:border-slate-800 px-4 py-4">
          <div class="max-w-4xl mx-auto">
            <!-- Uploaded Document Indicator -->
            <div x-show="uploadedDocuments.length > 0" 
                 class="mb-3 flex flex-wrap gap-2"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0">
              <template x-for="(doc, idx) in uploadedDocuments" :key="idx">
                <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-sage-100 dark:bg-sage-900/50 rounded-full text-sm">
                  <svg class="w-4 h-4 text-sage-600 dark:text-sage-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <span class="text-sage-700 dark:text-sage-300 font-medium truncate max-w-[150px]" x-text="doc.filename"></span>
                  <span class="text-sage-500 dark:text-sage-400 text-xs" x-text="doc.chunks + ' chunks'"></span>
                </div>
              </template>
</div>
            
            <div class="flex items-end gap-3">
              <!-- File Upload -->
              <label :class="isUploading ? 'opacity-50 cursor-wait' : 'cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700'"
                     class="flex-shrink-0 p-3 rounded-xl bg-slate-100 dark:bg-slate-800 transition-colors relative">
                <input type="file" 
                       class="hidden" 
                       @change="handleFileUpload($event)"
                       accept=".pdf,.txt,.md,.csv"
                       :disabled="isUploading"
                       x-ref="fileInput">
                <svg x-show="!isUploading" class="w-5 h-5 text-slate-600 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
                <!-- Upload spinner -->
                <svg x-show="isUploading" class="w-5 h-5 text-sage-500 animate-spin" fill="none" viewBox="0 0 24 24" style="display: none;">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
    </label>

              <!-- Text Input -->
              <div class="flex-1 relative">
                <textarea x-model="inputMessage"
                          @keydown.enter.prevent="!$event.shiftKey && sendMessage()"
                          placeholder="Type a message..."
                          rows="1"
                          class="w-full px-4 py-3.5 pr-14 bg-slate-100 dark:bg-slate-800 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-sage-500/50 transition-all placeholder:text-slate-400 dark:placeholder:text-slate-500"
                          style="min-height: 52px; max-height: 200px;"
                          x-ref="messageInput"
                          @input="autoResize($refs.messageInput)"></textarea>
              </div>
              
              <!-- Send Button -->
              <button @click="sendMessage()"
                      :disabled="!inputMessage.trim() || isTyping"
                      :class="inputMessage.trim() && !isTyping ? 'bg-gradient-to-r from-sage-500 to-sage-600 hover:from-sage-600 hover:to-sage-700 text-white shadow-lg shadow-sage-500/25' : 'bg-slate-200 dark:bg-slate-700 text-slate-400 cursor-not-allowed'"
                      class="flex-shrink-0 p-3.5 rounded-xl transition-all duration-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
              </button>
  </div>

            <p class="text-xs text-slate-500 dark:text-slate-500 text-center mt-3">
              SageAlpha.ai may produce inaccurate information. Always verify important financial data.
            </p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toast Notifications (HTMX powered) -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
  
  <script>
    function chatApp() {
      return {
        darkMode: localStorage.getItem('theme') === 'dark',
        sidebarOpen: false,
        user: { username: 'Guest', email: 'guest@local', avatar_url: null },
        sessions: [],
        currentSessionId: null,
        messages: [],
        inputMessage: '',
        isTyping: false,
        isUploading: false,
        isDragging: false,
        uploadedDocuments: [],
        currentDocument: null,
        socket: null,
        
        async init() {
          // Load user
          try {
            const res = await fetch('/user');
            if (res.ok) this.user = await res.json();
          } catch (e) { console.error('Failed to load user:', e); }
          
          // Load sessions
          await this.loadSessions();
          
          // Auto-open latest session or create new
          if (this.sessions.length > 0) {
            await this.openSession(this.sessions[0].id);
          }
          
          // Initialize WebSocket
          this.initSocket();
          
          // Apply theme
          this.applyTheme();
        },
        
        initSocket() {
          try {
            this.socket = io({
              transports: ['websocket', 'polling']
            });
            
            this.socket.on('connect', () => {
              console.log('[ws] Connected');
            });
            
            this.socket.on('typing', (data) => {
              this.isTyping = data.status;
            });
            
            this.socket.on('chat_response', (data) => {
              this.isTyping = false;
              this.messages.push({ role: 'assistant', content: data.response });
              this.$nextTick(() => this.scrollToBottom());
            });
            
            this.socket.on('error', (data) => {
              this.isTyping = false;
              this.showToast(data.message, 'error');
            });
          } catch (e) {
            console.warn('[ws] WebSocket not available, using HTTP fallback');
          }
        },
        
        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
          this.applyTheme();
        },
        
        applyTheme() {
          if (this.darkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        },
        
        async loadSessions() {
          try {
            const res = await fetch('/sessions');
            if (res.ok) {
              const data = await res.json();
              this.sessions = data.sessions || [];
            }
          } catch (e) { console.error('Failed to load sessions:', e); }
        },
        
        async newChat() {
          try {
            const res = await fetch('/sessions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title: 'New chat' })
            });
            if (res.ok) {
              const data = await res.json();
              this.currentSessionId = data.session.id;
              this.messages = [];
              await this.loadSessions();
              this.sidebarOpen = false;
            }
          } catch (e) { console.error('Failed to create session:', e); }
        },
        
        async openSession(sessionId) {
          try {
            const res = await fetch(`/sessions/${sessionId}`);
            if (res.ok) {
              const data = await res.json();
              this.currentSessionId = data.session.id;
              this.messages = (data.session.messages || []).map(m => ({
                role: m.role,
                content: m.content
              }));
              this.sidebarOpen = false;
              this.$nextTick(() => this.scrollToBottom());
            }
          } catch (e) { console.error('Failed to open session:', e); }
        },
        
        async sendMessage() {
          const msg = this.inputMessage.trim();
          if (!msg || this.isTyping) return;
          
          // Add user message
          this.messages.push({ role: 'user', content: msg });
          this.inputMessage = '';
          this.isTyping = true;
          this.$nextTick(() => this.scrollToBottom());
          
          // Try WebSocket first, fallback to HTTP
          if (this.socket && this.socket.connected) {
            this.socket.emit('chat_message', {
              message: msg,
              session_id: this.currentSessionId
            });
          } else {
            // HTTP fallback
            try {
              if (!this.currentSessionId) {
                const newRes = await fetch('/sessions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ title: 'New chat' })
                });
                const newData = await newRes.json();
                this.currentSessionId = newData.session.id;
              }
              
              const res = await fetch('/chat_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  session_id: this.currentSessionId,
                  message: msg
                })
              });
              
              const data = await res.json();
              this.isTyping = false;
              
              if (res.ok) {
                this.messages.push({ role: 'assistant', content: data.response });
                await this.loadSessions();
              } else {
                this.showToast(data.error || 'Failed to send message', 'error');
              }
            } catch (e) {
              this.isTyping = false;
              this.showToast('Network error. Please try again.', 'error');
            }
            
            this.$nextTick(() => this.scrollToBottom());
          }
        },
        
        async handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          // Validate file type
          const allowedTypes = ['.pdf', '.txt', '.md', '.csv'];
          const ext = '.' + file.name.split('.').pop().toLowerCase();
          if (!allowedTypes.includes(ext)) {
            this.showToast(`File type ${ext} not supported. Use: ${allowedTypes.join(', ')}`, 'error');
            return;
          }
          
          // Validate file size (max 50MB)
          const maxSize = 50 * 1024 * 1024;
          if (file.size > maxSize) {
            this.showToast('File too large. Maximum size is 50MB.', 'error');
            return;
          }
          
          this.isUploading = true;
          this.showToast(`Uploading "${file.name}"...`, 'info');
          
          try {
            // Ensure we have a session
            if (!this.currentSessionId) {
              const sessionRes = await fetch('/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: file.name.replace(/\.[^.]+$/, '') })
              });
              if (sessionRes.ok) {
                const sessionData = await sessionRes.json();
                this.currentSessionId = sessionData.session.id;
                await this.loadSessions();
              }
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('session_id', this.currentSessionId);
            
            // Upload file
            const res = await fetch('/upload', {
              method: 'POST',
              body: formData
            });
            
            const data = await res.json();
            
            if (!res.ok) {
              throw new Error(data.error || 'Upload failed');
            }
            
            // Success! Add to uploaded documents
            this.uploadedDocuments.push({
              filename: data.filename,
              doc_id: data.doc_id,
              chunks: data.chunks,
              url: data.url
            });
            
            this.showToast(`âœ“ ${file.name} processed (${data.chunks} chunks indexed)`, 'success');
            
            // Add system message about the upload
            this.messages.push({
              role: 'assistant',
              content: `ðŸ“„ I've analyzed "${data.filename}" and indexed ${data.chunks} text chunks. You can now ask me anything about this document!\n\nFor example:\nâ€¢ "What are the key findings?"\nâ€¢ "Summarize the financial highlights"\nâ€¢ "What risks are mentioned?"`
            });
            
            // Update the floating download button with this document
            this.currentDocument = {
              filename: data.filename,
              url: data.url
            };
            
            this.$nextTick(() => this.scrollToBottom());
            
          } catch (e) {
            console.error('Upload error:', e);
            this.showToast(`Upload failed: ${e.message}`, 'error');
          } finally {
            this.isUploading = false;
            // Reset file input
            if (this.$refs.fileInput) {
              this.$refs.fileInput.value = '';
            }
          }
        },
        
        handleDrop(event) {
          this.isDragging = false;
          const files = event.dataTransfer?.files;
          if (files && files.length > 0) {
            // Create a fake event to reuse handleFileUpload
            const fakeEvent = { target: { files: files } };
            this.handleFileUpload(fakeEvent);
          }
        },
        
        async downloadReport() {
          this.showToast('Preparing report...', 'info');
          try {
            const res = await fetch('/download-report');
            if (res.ok) {
              const blob = await res.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'SageAlpha_CRH_Report.pdf';
              a.click();
              window.URL.revokeObjectURL(url);
              this.showToast('Report downloaded!', 'success');
            } else {
              window.open('/report-html', '_blank');
            }
          } catch (e) {
            this.showToast('Download failed. Opening preview...', 'error');
            window.open('/report-html', '_blank');
          }
        },
        
        formatMessage(content) {
          if (!content) return '';
          let safe = content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
          
          // Convert URLs to links
          safe = safe.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-sage-600 dark:text-sage-400 underline">$1</a>');
          
          return safe;
        },
        
        formatDate(dateStr) {
          const date = new Date(dateStr);
          const now = new Date();
          const diff = now - date;
          
          if (diff < 86400000) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          } else if (diff < 604800000) {
            return date.toLocaleDateString([], { weekday: 'short' });
          }
          return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        },
        
        scrollToBottom() {
          const container = document.getElementById('messagesContainer');
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        },
        
        autoResize(el) {
          el.style.height = 'auto';
          el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        },
        
        showToast(message, type = 'info') {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          const bgColors = {
            info: 'bg-slate-800 text-white',
            success: 'bg-green-600 text-white',
            error: 'bg-red-600 text-white'
          };
          toast.className = `px-4 py-3 rounded-xl shadow-lg ${bgColors[type]} animate-slide-up`;
          toast.textContent = message;
          container.appendChild(toast);
          
          setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease';
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }
      };
    }
  </script>
</body>
</html>
